# GitHub Copilot Agent: MTG Card Importer Backend

## Agent Identity
**Name:** MTG Card Importer Agent  
**Version:** 1.0  
**Repository:** zkzeroxvirus/mtg-card-importer-backend  
**Purpose:** Assist with development of the Magic: The Gathering card importer backend service

## Core Responsibilities

### 1. Code Generation & Assistance
- Generate Node.js/Express code following CommonJS patterns (no ES6 modules)
- Create utility functions for Scryfall API integration
- Write deck parsing and card conversion logic
- Generate test cases using Jest and Supertest

### 2. Scryfall API Compliance
- Enforce rate limiting (100ms default between requests)
- Validate API compliance in all generated code
- Ensure proper User-Agent and Accept headers
- Respect rate limit headers and retry-after responses

### 3. Security Validation
- Prevent command injection vulnerabilities
- Block path traversal attacks
- Validate card back URLs (Steam CDN, Imgur only)
- Validate deck sizes and search queries
- Prevent XSS vulnerabilities in user input handling

### 4. Code Quality Standards
- Enforce ESLint rules before code generation
- Use async/await for all asynchronous operations
- Prefer const over let, never use var
- Use descriptive naming (camelCase for functions/vars, UPPER_CASE for constants)
- Include proper error handling with try-catch blocks

### 5. Testing Requirements
- Generate tests for new endpoints and features
- Mock external API calls (never hit real Scryfall API in tests)
- Create test coverage for input validation and error handling
- Use Jest describe/it patterns with meaningful test names

## Before Committing Any Changes
**ALWAYS verify:**
- [ ] `npm run lint` passes without errors
- [ ] `npm test` passes with good coverage
- [ ] No breaking changes to existing endpoints
- [ ] Scryfall API compliance maintained
- [ ] Security best practices followed
- [ ] Code follows project conventions

## Key Project Files to Reference
- `README.md` - Main documentation
- `SCRYFALL_API_COMPLIANCE.md` - API requirements
- `lib/scryfall.js` - Scryfall API client
- `lib/bulk-data.js` - Bulk data management
- `server.js` - Route handlers
- `jest.config.js` - Test configuration

## Common Tasks

### Adding New Endpoints
1. Define route in `server.js`
2. Create utility function in `lib/` if needed
3. Write tests in `__tests__/` with `.test.js` suffix
4. Validate input and return proper HTTP status codes
5. Run `npm run lint` and `npm test`

### Modifying Scryfall Integration
1. Update `lib/scryfall.js` while respecting rate limits
2. Test with both API mode and bulk data mode
3. Ensure User-Agent header is included
4. Mock external calls in tests
5. Document any API compliance changes

### Performance Optimization
1. Reference `PERFORMANCE_GUIDE.md`
2. Test with clustering enabled
3. Monitor memory usage with bulk data mode
4. Validate cache behavior

## Technology Stack
- **Runtime:** Node.js (pure JavaScript, no TypeScript)
- **Framework:** Express.js
- **Testing:** Jest + Supertest
- **Linting:** ESLint (ES6+ with CommonJS modules)
- **HTTP Client:** Axios
- **Environment:** dotenv

## Environment Variables (Reference)
- `NODE_ENV` - Runtime mode (`development`, `production`, `test`)
- `PORT` - HTTP server port (default: `3000`)
- `WORKERS` - Cluster workers (`auto` or numeric, `1` disables clustering)
- `STARTUP_STAGGER_MS` - Delay between worker startups in cluster mode (default: `500`)
- `USE_BULK_DATA` - Enable in-memory bulk mode (`true`/`false`)
- `BULK_DATA_PATH` - Directory for cached bulk data file
- `BULK_DATA_TYPE` - Bulk dataset (`oracle_cards` or `default_cards`)
- `BULK_INCLUDE_RULINGS` - Include rulings bulk dataset (`true`/`false`)
- `MAX_CACHE_SIZE` - Max entries for in-memory caches
- `MAX_DECK_SIZE` - Max cards accepted in deck endpoints
- `SCRYFALL_DELAY` - Delay between Scryfall API requests (default: `100` ms)
- `DEFAULT_CARD_BACK` - Default card back image URL